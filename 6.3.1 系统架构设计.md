# 6.2.1 系统架构设计

参考内容：
《大型网站技术架构——李智慧》
《Redis 设计与实现——黄健宏》
《Redis 深度历险——钱文品》
《亿级流量网站架构核心技术——张开涛》

## 基本概念

### 系统，这里指的是服务端系统，B/S架构下的Server部分
Apache、Nginx常用来负责Log日志和安全检查，Tomcat、JBoss、Jetty常用来负责业务逻辑和模板渲染

服务端系统和网络基础设施紧密相连

- 功能切分

	- CDN, Content Delivery Network，内容分配网络，是构筑在现有Internet上的一种流量分配网络。
（和Web前端关系密切） 

		- 主要用于缓存网站中的【静态数据】（比如CSS/JS/IMG），用户因此可以就近获取网页内容，加速网页数据的下载速度，提高了网络信息流动的效率。动态资源

			- 可以认为 CDN=镜像Mirror+缓存Cache+整体负载均衡GSLB

		- CDN架构

			- 各种DNS server、CDN server交织在一起形成网络。

		- 工作机制

			- CDN负载均衡

				- 概念：将工作任务平衡、分摊到多个操作单元上进行，从而提高服务器响应速度和使用效率，避免软件或硬件模块出现单点失效，解决网络拥塞问题，实现地理位置无关性。

					- 常在CDN集群、分布式数据集群、Web服务中使用

				- 方式一：链路负载均衡：通过DNS动态解析过程，由DNS来分配
				- 方式二：集群负载均衡：硬件负载均衡或软件负载均衡
				- 方式三：操作系统负载均衡

			- CDN动态加速

				- 概念：在CDN的DNS解析中通过链路探测来寻找、记录回源的最短路径。用户请求动态资源时，不会再CDN中找，而是要回源到源服务器，这个叫动态数据回源。

	- 网络应用

		- 含有本地缓存
		- 含有统一数据访问模块

	- 分布式缓存系统

		- 缓存路由
		- 路由分区

	- 文件系统
	- 数据库
	- 等等等等

- 硬件切分

	- 针对CDN、网络应用、缓存、文件、数据库划分多个服务器

### 系统的资源、负载和性能

- 复杂系统具有的资源和表现出的性能是和各个子系统互相挂钩的。
- 资源(resource)：物理服务器的功能组件，一些软件资源也可以被衡量，比如线程池、进程数等。系统的运行，需要各种资源，对于资源列表的确定，我们可以凭借对系统的了解确定，也可以通过绘制系统的功能块图的方式确定要衡量的资源。

	- 常见的物理资源：
CPU（cpu sockets）、CPU核（cores）、硬件线程（虚拟线程）hardware threads( virtual threads)
内存
网络接口
存储设备
存储或者网络的控制器
内部高速互联

- 负载(load)：有多少任务正在施加给系统，也就是系统的输入，要被处理的请求。对于数据库，那么负荷就包括了客户端段发送过来的命令和查询。

	- 负载如果超过了设计能力，往往导致性能问题。应用程序可能因为软件应用的配置或者系统架构导致性能降低，比如，如果一个应用程序是单线程的，无疑它会受制于单线程架构，因为只能利用一个核，后续的请求都必须排队，不能利用其他核，但也可能仅仅是因为负载太多了。负载太多将导致排队、高延时，比如，一个多线程应用程序，你发现所有cpu都是忙的，都在处理任务，这个时候，仍然发生排队，系统负载很高，这个时候很可能是施加了过高的负荷。

如果在云中，你也许可以简单地增加更多的节点来处理过高的负荷，在一般的生产应用中，简单增加节点有时解决不了问题，你需要进行调优和架构迭代。

- 性能指标和表征

	- 利用率(ulilization)：利用率用来衡量提供服务的资源的忙碌程度，它基于某一段时间间隔内，系统资源用于真正执行工作的时间百分比。

		- 利用率可以是基于时间的，比如cpu的利用率：某颗cpu的利用率或者整体系统的cpu利用率。比如磁盘的利用率，我们可使用iostat命令检查%util。
利用率 = 忙的时间 / 总计时间

利用率也可以是基于容量的，它可以表示我们的磁盘或者内存或者网络的使用程度，比如90%的磁盘空间被使用，80%的内存被使用，80%的网络带宽被使用。

往往利用率的高位会导致资源饱和。利用率100%往往意味着有瓶颈，可以检查饱和度、系统性能加以确定。该资源不能提供服务的程度被标识为它的饱和度，见下面饱和的详细解释。
		- 利用率超过60%也可能有问题，如果是检测的粒度比较大，很可能掩盖了偶尔的100%的峰值，一些资源，如磁盘，在60%的利用率的时候，就开始性能变差了。

	- 响应时间(response time)：也叫延迟，指操作执行需要的耗时。它包括了等待时间和执行时间。对于一个数据库查询，那么响应时间包括了从客户端发布查询命令到数据库处理查询，传输结果给客户端的所有时间。延迟可以在不同的环节衡量，比如访问站点的装载时间包括DNS延迟、tcp连接延迟、tcp数据传输时间。延迟也可以在更高的级别理解，包括数据传输时间和其他时间，比如从用户点击链接到网页内容传输，并在用户的电脑屏幕上渲染完毕，这也是一种延迟。延迟是以时间做量度来衡量的，可以很方便地进行比较，其他的一些指标不容易衡量、比较，比如IOPS，那么，你可以转化为延迟来进行比较。
	- 吞吐(throughput)：处理任务的速率。对于网络传输，吞吐一般指每秒传输的字节数，对于数据库来说，指的是每秒查询数（QPS）或者每秒事务数。
	- 并发(concurrency)：指得是系统能够并行执行多个操作的能力。如果数据库能够充分利用CPU的多核能力，那么往往意味着更高的并发处理能力。
	- 容量(capacity)：容量指的是系统可以提供的处理负荷的能力。我们日常运维中有一项很重要的工作就是容量规划，即确保随着负荷增长，我们的系统仍然能够处理负荷，也就是说，当我们的吞吐增加后，我们仍然能够确保服务良好、稳定。容量也指我们的资源使用极限，比如我们的磁盘空间占用，在磁盘空间到达一定阀值后，我们可能要考虑扩容。
	- 伸缩性(scalability)：我们可以理解为两个层面的意思。一、在资源的利用率不断增加的情况下，响应时间和资源利用率之间的关系，资源利用率越高，响应时间仍然能保持稳定，那么我们说他的伸缩性好，但如果资源利用率高，响应时间开始劣化，我们认为其伸缩性不佳。
二、伸缩性还有一层意义，表征系统不断扩展的能力，系统通过不断增加节点或者资源，处理不断增长的负荷，同时依然能够保持合理的响应时间。

### 软件架构：软件整体结构与组件的抽象描述，用于指导大型软件系统各方面的设计

### 软件架构任务的核心要素：在满足系统功能需求前提下、性能、可用性、伸缩性、扩展性、安全性

- 每一项性能指标和非性能特征都要使用多种技术来改进

## 消息队列：解决各子系统之间的
通信问题

### 传统架构，无消息队列中间件

- 功能

	- 满足高并发业务场景的基本需求

		- 如何实现？

- 不足

	- 各子系统间耦合度过高、不能实现各子系统间的异步操作、不能应对高峰流量

### 消息队列 MQ，Message Queue

- 功能：

	- 解耦

		- 为何能实现？

	- 异步

		- 为何能实现？

	- 削峰

		- 为何能实现？

- 不足

	- 总体上，简单引入消息队列后，系统可用性降低、复杂度提高、可靠性降低、还带来存储一致性等问题
	- 系统的可用性问题
	- 消息传输的幂等性，消息的重复消费问题

		- 为何产生？
		- 如何解决？

	- 消息丢失问题

		- 为何产生？
		- 如何解决？

	- 消息传输的顺序性

		- 为何产生？
		- 如何解决？

	- 消息的延时和过期失效

		- 为何产生？
		- 如何解决？

	- 消息队列的容量不足问题

		- 为何产生？
		- 如何解决？

	- 存储一致性问题

		- 为何产生？
		- 如何解决？

- 现有的消息队列中间件技术比较
Kafka、ActiveMQ、RabbitMQ、RocketMQ的适用场景
- 如何设计一个合理的消息队列？

## 搜索引擎 ：解决数据检索问题

### 现有的搜索库lucene、基于lucene的elasticsearch（提供了简单易用的 restful api / Java api 接口）

## 高性能架构
（重点：提高并发性）

### 网站的性能测试

- 方法
- 指标

	- 响应时间（最重要指标）
	- 并发数（技术难点）

		- 如何架构出高并发的系统？

	- 吞吐量

### 性能分析

### 性能优化的三个方面

- Web前端性能优化

	- 优化浏览器访问
	- 反向代理+负载均衡

		- 传统代理服务器：代理浏览器发送HTTP请求
反向代理服务器：代理网站应用服务器接受HTTP请求，再转发到Web服务器集群。同时也可用于实现负载均衡功能。

	- CDN服务

- 应用服务器性能优化

	- 数据方面：分布式缓存

		- 缓存的实现原理：Hash表

			- 缓存预热
LRU最近最久未使用算法

		- 分布式缓存架构

			- JBoss Cache架构，各服务器之间更新同步，适用企业内部应用系统
			- Memcached架构，各服务器之间互不通信

		- 缓存产生的故障

			- 缓存雪崩与缓存可用性
			- 脏读与数据一致性
			- 缓存穿透

	- 异步操作

		- 消息队列

	- 集群

		- 负载均衡服务器

	- 代码优化

		- 多线程编程
		- 资源复用，模式有两种，资源复用和对象池
		- 垃圾回收

- 存储服务器性能优化

	- 存储介质：机械硬盘、固态硬盘
	- 传统机械硬盘-B+树数据结构和算法-关系型数据库
传统机械硬盘-LSM树-NoSql数据库

## 微服务架构

### Spring Cloud

## 高可用架构

## 伸缩性架构

## 安全性架构

*XMind: ZEN - Trial Version*